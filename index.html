<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      #genre {
        display: none;
      }
      #difficulty {
        display: none;
      }
      #home-btn {
        display: none;
      }
      .choice-btn {
        display: block;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <h1 id="title">ようこそ</h1>
    <h3 id="genre"></h3>
    <h3 id="difficulty"></h3>
    <hr />
    <p id="question-text">以下のボタンをクリック</p>
    <hr />
    <button id="start-btn">開始</button>
    <button id="home-btn">ホームに戻る</button>
    <div id="choice-area"></div>
    <script>
      "use strict";

      //DOMから要素取得
      const title = document.getElementById("title");
      const genre = document.getElementById("genre");
      const difficulty = document.getElementById("difficulty");
      const questionText = document.getElementById("question-text");
      const startBtn = document.getElementById("start-btn");
      const choiceArea = document.getElementById("choice-area");
      const homeBtn = document.getElementById("home-btn");
      let choiceBtn = document.querySelectorAll(".choice-btn");

      fetch("https://opentdb.com/api.php?amount=10&type=multiple")
        .then((response) => response.json())
        .then((json) => {
          //クラスの設定
          class Question {
            constructor(n) {
              this.dataObj = json.results[n];
              this.title = `問題 ${n + 1}`;
              this.genre = `[ジャンル] ${json.results[n].category}`;
              this.difficultyText = `[難易度] ${json.results[n].difficulty}`;
              this.text = json.results[n].question;
            }
            show() {
              //クイズを表示させる
              startBtn.style.display = "none";
              genre.style.display = "block";
              difficulty.style.display = "block";
              title.textContent = this.title;
              genre.textContent = this.genre;
              difficulty.textContent = this.difficultyText;
              questionText.textContent = this.text;
              const answers = [];
              const answer = answers.push(this.dataObj.correct_answer);
              const choiceAnswers = [
                ...this.dataObj.incorrect_answers,
                ...answers,
              ];
              for (let i = 0; i < choiceAnswers.length; i++) {
                const choiceBtn = document.createElement("button");
                choiceBtn.setAttribute("class", "choice-btn " + i);
                choiceBtn.textContent = choiceAnswers[i];
                choiceArea.appendChild(choiceBtn);
              }
            }
          }

          //複数のインスタンス作成し配列としてまとめる
          function instances() {
            const Questions = [];
            for (let i = 0; i < 10; i++) {
              const instance = new Question(i);
              Questions.push(instance);
            }
            return Questions;
          }
          const QuestionInstances = instances();
          console.log(QuestionInstances);
          //開始ボタンクリックでクイズを表示
          startBtn.addEventListener("click", () => {
            title.textContent = "取得中";
            questionText.textContent = "少々お待ちください";
            window.setTimeout(function () {
              QuestionInstances[0].show();
            }, 1000); //１秒後にクイズ表示
          });

          //答え選択ボタンクリックで次のクイズを表示
          const answerBtn = choiceArea.children;
          const trueCounts = [];
          let i = 0;
          choiceArea.addEventListener("click", (e) => {
            i++;
            if (e.target.className === "choice-btn 3") {
              //正解のカウントと次の出題
              trueCounts.push(1);
              choiceArea.innerHTML = "";
              lastAnswer();
            } else if (e.target.className !== "choice-btn 3") {
              //次の出題
              choiceArea.innerHTML = "";
              lastAnswer();
            }
            console.log(trueCounts); //test
          });

          //ラスト問題回答で正答数表示/ラスト以外は次の問題表示
          function lastAnswer() {
            if (i === 10) {
              title.textContent =
                "あなたの正答数は" + trueCounts.length + "です";
              questionText.textContent =
                "再度チャレンジしたい場合は以下をクリック！！";
              genre.style.display = "none";
              difficulty.style.display = "none";
              homeBtn.style.display = "block";
              choiceArea.innerHTML = "";
            } else {
              QuestionInstances[i].show();
            }
          }

          //homebtnクリックで最初に戻る
          homeBtn.addEventListener("click", () => {
            title.textContent = "ようこそ";
            questionText.textContent = "以下のボタンをクリック";
            homeBtn.style.display = "none";
            startBtn.style.display = "block";
            i = 0; //カウンターを０にリセット
            trueCounts.length = 0; //配列を空にする
          });

          //test
          console.log(json);
          console.log(json.results);
          console.log(json.results[0].question);
        });
    </script>
  </body>
</html>
